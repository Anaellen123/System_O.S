{% load static %}

<header id="header_index">
    <div id="yellow">
        <div id="logo">
        <img src="{% static 'img/test3.png' %}" alt="Portal de Servi√ßo - Socorro SE">
        </div>
        <nav id="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="{% url 'index' %}"
                    class="menu-link {% if request.resolver_match.url_name == 'index' %}active{% endif %}">
                    In√≠cio
                    </a>
                </li>

                <li class="nav-item">
                    <a href="{% url 'solicitar_servico' %}"
                    class="menu-link {% if request.resolver_match.url_name == 'solicitar_servico' %}active{% endif %}">
                    Solicitar servi√ßo
                    </a>
                </li>

                <li class="nav-item">
                    <a href="{% url 'login_admin' %}"
                    class="menu-link {% if request.resolver_match.url_name == 'login_admin' %}active{% endif %}">
                    Login
                    </a>
                </li>
            </ul>
        </nav>

    </div>

    <div id="meio">
        <div id="title">
            <h1>Servi√ßos Urbanos</h1>
            <span>ao seu alcance</span>
        </div>
        <div id="text-title">
            <p>Solicite servi√ßos urbanos e acompanhe o status da 
                sua ordem de forma simples e transparente
            </p>
        </div>
    </div>
    <div class="hero-actions">
        <a href="{% url 'solicitar_servico' %}" class="solicitar_servico">
            <i class="bi bi-clipboard-check"></i>
            Solicitar servi√ßo
        </a>

        <a href="#" id="btnAcompanhar" class="acompanhar_servico">
            <i class="bi bi-search"></i>
            Acompanhar servi√ßo
        </a>
    </div>
    <div class="hero-info">
        <div class="info-item">
            <div class="info-ico">
            <i class="bi bi-calendar3"></i>
            </div>
            <div class="info-text">
            <span class="info-label">Prazo m√©dio</span>
            <strong class="info-value">30 dias</strong>
            </div>
        </div>

        <div class="info-divider"></div>

        <div class="info-item">
            <div class="info-ico">
            <i class="bi bi-geo-alt"></i>
            </div>
            <div class="info-text">
            <span class="info-label">Acompanhamento</span>
            <strong class="info-value">Em tempo real</strong>
            </div>
        </div>
    </div>
    <div id="modalAcompanhar" class="modal-overlay" aria-hidden="true">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-header">
                <div class="modal-header-left">
                    <div class="modal-icon">
                    <i class="bi bi-search"></i>
                    </div>

                    <div class="modal-header-text">
                    <h2 id="modalTitle">Acompanhar OS</h2>
                    <p>Digite o n√∫mero completo da OS para consultar o status</p>
                    </div>
                </div>

                <button type="button" class="modal-close" id="modalClose" aria-label="Fechar modal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <label class="modal-label" for="osInput">
                    <i class="bi bi-file-earmark-text"></i>
                    N√∫mero da OS
                </label>

                <div class="modal-form-row">
                    <div class="modal-input-wrap">
                    <input
                        id="osInput"
                        name="os_number"
                        class="modal-input"
                        type="text"
                        inputmode="text"
                        placeholder="OS-20260130-0001"
                        autocomplete="off"
                        autocapitalize="characters"
                        spellcheck="false"
                    />
                    </div>

                    <button type="button" class="modal-btn" id="btnConsultar">
                    <i class="bi bi-search"></i>
                    Consultar
                    </button>
                </div>

                <p class="modal-example">
                    Exemplo: <strong>OS-20260130-0001</strong>
                </p>

                <!-- onde voc√™ pode mostrar mensagens -->
                <p id="osMsg" style="margin:8px 0 0; font-size:13px; color:#6d7a90;"></p>
            </div>

        </div>
    </div>



</header>
<script>
(function () {
  const openBtn = document.getElementById("btnAcompanhar");
  const modal = document.getElementById("modalAcompanhar");
  const closeBtn = document.getElementById("modalClose");
  const input = document.getElementById("osInput");
  const consultarBtn = document.getElementById("btnConsultar");
  const msg = document.getElementById("osMsg");

  function openModal() {
    modal.classList.add("is-open");
    modal.setAttribute("aria-hidden", "false");
    if (msg) msg.textContent = "";
    setTimeout(() => input && input.focus(), 50);
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    modal.classList.remove("is-open");
    modal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
  }

  function setMsg(text, type = "info") {
    if (!msg) return;
    msg.textContent = text;

    // cores simples
    if (type === "ok") msg.style.color = "#15803d";       // verde
    else if (type === "warn") msg.style.color = "#b45309"; // laranja
    else if (type === "err") msg.style.color = "#b91c1c";  // vermelho
    else msg.style.color = "#6d7a90";                     // cinza
  }

  function statusEmoji(status) {
    if (status === "OPEN") return "üü°";
    if (status === "IN_PROGRESS") return "üîµ";
    if (status === "DONE") return "üü¢";
    return "‚ÑπÔ∏è";
  }

  async function consultarStatus(osNumber) {
    // garante padr√£o
    const clean = (osNumber || "").trim().toUpperCase();

    // encode pra n√£o quebrar URL
    const url = `/api/os-status/${encodeURIComponent(clean)}/`;

    const res = await fetch(url, { headers: { "Accept": "application/json" } });

    const ct = res.headers.get("content-type") || "";
    if (!ct.includes("application/json")) {
      const txt = await res.text();
      throw new Error("Resposta inv√°lida do servidor (n√£o √© JSON). " + txt.slice(0, 80));
    }

    const data = await res.json();
    if (!res.ok || !data.ok) {
      throw new Error(data.message || "N√£o foi poss√≠vel consultar a OS.");
    }
    return data;
  }

  // abrir
  openBtn?.addEventListener("click", (e) => {
    e.preventDefault();
    openModal();
  });

  // fechar no X
  closeBtn?.addEventListener("click", closeModal);

  // fechar clicando fora
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });

  // ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal.classList.contains("is-open")) closeModal();
  });

  // Enter no input
  input?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      consultarBtn?.click();
    }
  });

  // consultar
  consultarBtn?.addEventListener("click", async () => {
    const val = (input?.value || "").trim().toUpperCase();

    if (!val) {
      setMsg("Digite o n√∫mero completo da OS (ex: OS-20260130-0001).", "warn");
      return;
    }

    setMsg("Consultando... ‚è≥", "info");

    try {
      const data = await consultarStatus(val);

      const emoji = statusEmoji(data.status);
      setMsg(
        `${emoji} ${data.os_number} ‚Äî Status: ${data.status_label} ¬∑ Servi√ßo: ${data.service_type} ¬∑ Criada em: ${data.created_at}`,
        "ok"
      );
    } catch (err) {
      console.error(err);
      setMsg(`‚ùå ${err.message}`, "err");
    }
  });
})();
input.addEventListener("input", () => input.value = input.value.toUpperCase());

</script>



