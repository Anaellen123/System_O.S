{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Ordens de Servi√ßo{% endblock %}
{% block page_title %}Ordens de Servi√ßo{% endblock %}

{% block content %}
<style>
  .page { padding: 22px; }
  .page-sub { margin: 4px 0 18px; color: #6b7280; font-size: 13px; }

  .toolbar {
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    margin: 12px 0 14px;
  }

  .search {
    flex:1;
    display:flex; gap:10px; align-items:center;
    background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;
    max-width: 520px;
  }
  .search input { border:none; outline:none; width:100%; font-size:14px; }

  .filters { display:flex; gap:10px; align-items:center; }
  .select, .btn {
    border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:10px 12px;
    font-size:14px; cursor:pointer;
  }
  .btn.primary { background:#0b5fff; border-color:#0b5fff; color:#fff; font-weight:700; text-decoration:none; }

  .cards { display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap:14px; margin: 14px 0 18px; }
  .card {
    background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px;
    display:flex; justify-content:space-between; align-items:flex-start;
  }
  .card small { color:#6b7280; display:block; margin-bottom:6px; }
  .card .num { font-size:22px; font-weight:900; }
  .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#f9fafb; }

  .table-wrap { background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; }
  table { width:100%; border-collapse:collapse; }
  thead th {
    text-align:left; font-size:12px; color:#6b7280; font-weight:700;
    padding: 12px 14px; background:#fafafa; border-bottom:1px solid #eee;
  }
  tbody td { padding: 14px; border-bottom:1px solid #f1f5f9; font-size:14px; vertical-align:top; }

  /* üëá LINHA CLIC√ÅVEL */
  .tr-click { cursor:pointer; }
  .tr-click:hover { background:#fcfcfd; }

  .who { display:flex; flex-direction:column; }
  .who b { font-size:14px; }
  .who span { font-size:12px; color:#6b7280; }

  .tag { font-size:12px; padding:6px 10px; border-radius:999px; display:inline-block; border:1px solid #e5e7eb; background:#f8fafc; }

  .status { font-size:12px; padding:6px 10px; border-radius:999px; display:inline-block; font-weight:700; }
  .s-open { background:#fff7ed; color:#c2410c; border:1px solid #fed7aa; }
  .s-progress { background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; }
  .s-done { background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; }

  @media (max-width: 1100px){
    .cards { grid-template-columns: repeat(2, minmax(180px, 1fr)); }
    .toolbar { flex-direction:column; align-items:stretch; }
    .search { max-width:none; }
    .filters { justify-content:flex-end; }
  }
</style>

<p class="page-sub">Gerencie todas as ordens de servi√ßo do sistema</p>

<div class="cards">
  <div class="card">
    <div>
      <small>Total de OS</small>
      <div class="num">{{ total }}</div>
    </div>
    <span class="pill">üìÑ</span>
  </div>

  <div class="card">
    <div>
      <small>OS ativas</small>
      <div class="num">{{ ativas }}</div>
    </div>
    <span class="pill">üü¶</span>
  </div>

  <div class="card">
    <div>
      <small>Vencidas*</small>
      <div class="num">{{ vencidas }}</div>
    </div>
    <span class="pill">‚ö†Ô∏è</span>
  </div>

  <div class="card">
    <div>
      <small>Status atual</small>
      <div class="num" style="font-size:16px; font-weight:800; margin-top:6px;">
        {{ status_atual|upper }}
      </div>
    </div>
    <span class="pill">üéØ</span>
  </div>
</div>

<div class="toolbar">
  <form class="search" method="get">
    üîé
    <input name="q" placeholder="Buscar por nome, CPF/CNPJ, telefone..." value="{{ request.GET.q|default:'' }}">
  </form>

  <div class="filters">
    <form method="get">
      {% if request.GET.q %}
        <input type="hidden" name="q" value="{{ request.GET.q }}">
      {% endif %}
      <select class="select" name="status" onchange="this.form.submit()">
        <option value="">Todos os status</option>
        <option value="OPEN" {% if request.GET.status == "OPEN" %}selected{% endif %}>Pendente</option>
        <option value="IN_PROGRESS" {% if request.GET.status == "IN_PROGRESS" %}selected{% endif %}>Em andamento</option>
        <option value="DONE" {% if request.GET.status == "DONE" %}selected{% endif %}>Conclu√≠da</option>
      </select>
    </form>

    <a class="btn primary" href="{% url 'os_create' %}">+ Nova OS</a>
  </div>
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>N√∫mero</th>
        <th>Solicitante</th>
        <th>Servi√ßo</th>
        <th>Bairro</th>
        <th>Status</th>
        <th>Cria√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      {% for os in os_list %}
        <tr class="tr-click"
            onclick="window.open('{% url 'os_detail' os.pk %}', '_blank')">
          <td><b>{{ os.os_number }}</b></td>

          <td>
            <div class="who">
              <b>{{ os.full_name }}</b>
              <span>{{ os.phone }}</span>
            </div>
          </td>

          <td><span class="tag">{{ os.service_type }}</span></td>

          <td>{{ os.neighborhood|default:"-" }}</td>

          <td>
            {% if os.status == "OPEN" %}
              <span class="status s-open">Pendente</span>
            {% elif os.status == "IN_PROGRESS" %}
              <span class="status s-progress">Em andamento</span>
            {% else %}
              <span class="status s-done">Conclu√≠da</span>
            {% endif %}
          </td>

          <td>{{ os.created_at|date:"d/m/Y" }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6" style="padding:20px; color:#6b7280;">Nenhuma OS encontrada.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<p style="margin-top:10px; font-size:12px; color:#6b7280;">
  * ‚ÄúVencidas‚Äù est√° como exemplo (mais de 30 dias) porque seu model n√£o tem campo de prazo.
</p>
{% endblock %}
